<script setup lang="ts">
import Overlay from "../_Base/Loaders/Overlay.vue";
import TwoFaAppSetupForm from "@/Forms/User/TwoFaAppSetupForm.vue";
import { dataGet, dataPost } from "@/Composables/axiosWrapper.module";
import { ref } from "vue";

defineEmits<{
    success: [];
}>();

const isLoading = ref<boolean>(true);
const qrCode = ref<string>();
const qrUrl = ref<string>();

/**
 * Get the QR Code Image from server
 */
const getQrCode = () => {
    dataPost(route("two-factor.enable"), []).then((res) => {
        if (res) {
            dataGet(route("two-factor.qr-code")).then((res) => {
                if (res) {
                    console.log(res);
                    qrCode.value = res.data.svg;
                    qrUrl.value = res.data.url;
                    isLoading.value = false;
                }
            });
        }
    });
};

const triggerSetup = () => {
    getQrCode();
};

defineExpose({ triggerSetup });
</script>

<template>
    <Overlay :loading="isLoading">
        <h3 class="text-center">
            Scan the QR Code below with your Authenticator App, or click on the
            QR Code from your mobile device.
        </h3>
        <div class="flex justify-center my-3">
            <a :href="qrUrl" v-html="qrCode" class="min-h-32" />
        </div>
        <h4 class="text-center">
            Enter the code generated by the Authenticator App to confirm setup.
        </h4>
        <TwoFaAppSetupForm @success="$emit('success')" />
    </Overlay>
</template>
